@model QA.Models.Question
@using QA.Models
@{
    int ol = 0;
    int ctu = 0;
    ViewBag.Title = "Detail";
    Layout = "~/Views/Shared/_Layout.cshtml";
    QuestionAndAnswerEntities db = new QuestionAndAnswerEntities();
    Account ac = (Account)Session["TaiKhoan"];
    PointA pa = db.PointAS.SingleOrDefault(m => m.IDQuestion == Model.IDQuestion);
    if (pa != null)
    {
        ol = pa.IDAnswer;
    }
    if (ac != null)
    {
        ctu = ac.IDAccount;
    }
    DateTime aDateTime = DateTime.Now;
}
@if (ViewBag.ThongBao != null)
{
    <script>
        alert("@Html.Raw(@ViewBag.ThongBao)")
    </script>
}
<style>
    .fa-sort-asc::before {
        content: "\f0de";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
    }

    .fa-sort-desc::before {
        content: "\f0dd";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
    }

    .mb-30 {
        margin-bottom: 30px;
    }

    .card-style {
        background: #fff;
        box-sizing: border-box;
        padding: 25px 30px;
        position: relative;
        border: 1px solid #e2e8f0;
        box-shadow: 0px 10px 20px rgb(200 208 216 / 30%);
        border-radius: 10px;
    }
</style>
<script src="https://cdn.ckeditor.com/4.14.0/standard/ckeditor.js"></script>
<!-- Breadcrumb Start -->
<div class="breadcrumb-wrap">
    <div class="container">
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Detail", "Home")">Home</a></li>
            <li class="breadcrumb-item active"><a href="@Url.Action("Detail", "Home", new { id =Model.IDQuestion})">Deail</a></li>
        </ul>
    </div>
</div>
<!-- Breadcrumb End -->
<!-- Single News Start-->
<div class="single-news">
    <div class="container">
        <div class="row">
            <div class="col-lg-9 card-style mb-30">
                <div class="sn-container">
                    <div class="qa_container" style="margin-left:-5%;">
                        <div class="col1">
                            <div class="userimg">
                                <img src="~/Content/Images/avatar/@Model.Account.Avatar"
                                     alt="" srcset=""></i>
                            </div>
                            <div class="vote">
                                @if (Session["TaiKhoan"] == null || ac.IDAccount == Model.IDAccount)
                                {
                                    <button class="upvote v" id="increaseq" disabled>
                                        <i class="fa fa-sort-asc"></i>
                                    </button>
                                    <div class="count" id="point"></div>
                                    <button class="downvote v" id="reduceq" disabled>
                                        <i class="fa fa-sort-desc"></i>
                                    </button>
                                }
                                else
                                {
                                    Point po = db.Points.SingleOrDefault(n => n.IDAccount == ac.IDAccount && n.IDQuestion == Model.IDQuestion);
                                    if (po == null)
                                    {
                                        <button class="upvote v" id="increaseq">
                                            <i class="fa fa-sort-asc"></i>
                                        </button>
                                        <div class="count" id="point"></div>
                                        <button class="downvote v" id="reduceq">
                                            <i class="fa fa-sort-desc"></i>
                                        </button>
                                    }
                                    else if (po.Increase == true)
                                    {
                                        <button class="upvote v" id="increaseq" disabled>
                                            <i class="fa fa-sort-asc"></i>
                                        </button>
                                        <div class="count" id="point"></div>
                                        <button class="downvote v" id="reduceq">
                                            <i class="fa fa-sort-desc"></i>
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="upvote v" id="increaseq" onclick="PointAs()">
                                            <i class="fa fa-sort-asc"></i>
                                        </button>
                                        <div class="count" id="point"></div>
                                        <button class="downvote v" disabled id="reduceq">
                                            <i class="fa fa-sort-desc"></i>
                                        </button>}
                                }
                            </div>
                        </div>
                        <div class="col2">
                            <div class="infobar cdw">
                                <div class="name">@Model.Account.UserName</div>
                                <div>
                                    <a class=" na dh"><i class="fa fa-comments-o" aria-hidden="true"></i> @Html.Action("TotalAs", "Question", new { id = Model.IDQuestion }) Answers</a>
                                    <a class=" views dh">
                                        <i class="fa fa-eye" aria-hidden="true"></i>
                                        @Model.View views
                                    </a>
                                </div>
                                <div class="date">Asked : @Model.Datetime</div>
                            </div>
                            <div class="heading" style="font-weight:bold;font-size:large;">
                                @Model.Topic
                            </div>
                            <br>
                            <div class="details">
                                @Html.Raw(Model.Content)
                            </div>
                        </div>

                    </div>

                    <div id="ans">
                    </div>
                    <div>
                        @using (Html.BeginForm("AddA", "Question", new { id = Model.IDQuestion }))
                        {
                            <p style="font-weight:bold;font-size:larger;">Comment</p>
                            <textarea id="comment" rows="5" cols="80" name="content"></textarea>
                            <div>
                                <input type="submit" value="Trả lời" />
                            </div>
                        }
                    </div>
                </div>
                @Html.Action("Answer", "Question")
                <div class="sn-related">
                    <h2>Related News</h2>
                    <div class="row sn-slider">
                        <div class="col-md-4">
                            <div class="sn-img">
                                <img src="img/news-350x223-1.jpg" />
                                <div class="sn-title">
                                    <a href="">Interdum et fames ac ante</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="sn-img">
                                <img src="img/news-350x223-2.jpg" />
                                <div class="sn-title">
                                    <a href="">Interdum et fames ac ante</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="sn-img">
                                <img src="img/news-350x223-3.jpg" />
                                <div class="sn-title">
                                    <a href="">Interdum et fames ac ante</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="sn-img">
                                <img src="img/news-350x223-4.jpg" />
                                <div class="sn-title">
                                    <a href="">Interdum et fames ac ante</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="sidebar">
                    <div class="sidebar-widget card-style">
                        <h2 class="sw-title">Xếp hạng</h2>
                        <div class="news-list">
                            @Html.Action("Ranking", "Question")
                        </div>
                    </div>
                    <div class="sidebar-widget card-style">
                        <h2 class="sw-title">Câu hỏi mới</h2>
                        <div class="category">
                            <ul>
                                @Html.Action("NewQuestion", "Question")
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Single News End-->
@section Scripts{

    <script>
        CKEDITOR.ClassicEditor.create(document.getElementById("comment"), {
            // https://ckeditor.com/docs/ckeditor5/latest/features/toolbar/toolbar.html#extended-toolbar-configuration-format
            toolbar: {
                items: [
                    'exportPDF', 'exportWord', '|',
                    'heading', '|',
                    'bold', 'italic', 'code', 'removeFormat', '|',
                    'bulletedList', 'numberedList', 'todoList', '|',
                    'undo', 'redo',
                    '-',
                    'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', 'highlight', '|',
                    'alignment', '|',
                    'link', 'insertImage', 'blockQuote', 'insertTable', 'mediaEmbed', 'codeBlock', 'htmlEmbed', '|',
                    'textPartLanguage', '|',
                    'sourceEditing'
                ],
                shouldNotGroupWhenFull: true
            },
            // Changing the language of the interface requires loading the language file using the <script> tag.
            // language: 'es',
            list: {
                properties: {
                    styles: true,
                    startIndex: true,
                    reversed: true
                }
            },
            // https://ckeditor.com/docs/ckeditor5/latest/features/headings.html#configuration
            heading: {
                options: [
                    { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                    { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                    { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                    { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                    { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' },
                    { model: 'heading5', view: 'h5', title: 'Heading 5', class: 'ck-heading_heading5' },
                    { model: 'heading6', view: 'h6', title: 'Heading 6', class: 'ck-heading_heading6' }
                ]
            },
            // https://ckeditor.com/docs/ckeditor5/latest/features/editor-placeholder.html#using-the-editor-configuration
            placeholder: 'Welcome to CKEditor 5!',
            // https://ckeditor.com/docs/ckeditor5/latest/features/font.html#configuring-the-font-family-feature
            fontFamily: {
                options: [
                    'default',
                    'Arial, Helvetica, sans-serif',
                    'Courier New, Courier, monospace',
                    'Georgia, serif',
                    'Lucida Sans Unicode, Lucida Grande, sans-serif',
                    'Tahoma, Geneva, sans-serif',
                    'Times New Roman, Times, serif',
                    'Trebuchet MS, Helvetica, sans-serif',
                    'Verdana, Geneva, sans-serif'
                ],
                supportAllValues: true
            },
            // https://ckeditor.com/docs/ckeditor5/latest/features/font.html#configuring-the-font-size-feature
            fontSize: {
                options: [10, 12, 14, 'default', 18, 20, 22],
                supportAllValues: true
            },
            // Be careful with the setting below. It instructs CKEditor to accept ALL HTML markup.
            // https://ckeditor.com/docs/ckeditor5/latest/features/general-html-support.html#enabling-all-html-features
            htmlSupport: {
                allow: [
                    {
                        name: /.*/,
                        attributes: true,
                        classes: true,
                        styles: true
                    }
                ]
            },
            // Be careful with enabling previews
            // https://ckeditor.com/docs/ckeditor5/latest/features/html-embed.html#content-previews
            htmlEmbed: {
                showPreviews: true
            },
            // https://ckeditor.com/docs/ckeditor5/latest/features/link.html#custom-link-attributes-decorators
            link: {
                decorators: {
                    addTargetToExternalLinks: true,
                    defaultProtocol: 'https://',
                    toggleDownloadable: {
                        mode: 'manual',
                        label: 'Downloadable',
                        attributes: {
                            download: 'file'
                        }
                    }
                }
            },

            removePlugins: [
                'CKBox',
                'CKFinder',
                'EasyImage',
                'RealTimeCollaborativeComments',
                'RealTimeCollaborativeTrackChanges',
                'RealTimeCollaborativeRevisionHistory',
                'PresenceList',
                'Comments',
                'TrackChanges',
                'TrackChangesData',
                'RevisionHistory',
                'Pagination',
                'WProofreader',
                'MathType'
            ]
        });
    </script>
    <script>
        $(document).ready(function () {
           // LoadAnswer();
            LoadPoint();

        })
        $('#submit').click(function () {
            let content = $('#comment').val().trim();
            if (content.length == null) {
                alert('Vui lòng nhập');
                return;
            }
            $.ajax({
                url: '@Url.Action("PostComment", "Question")',
                type: 'post',
                data: {
                    nd: content,
                    id:@Model.IDQuestion},
                success: function (data) {
                    if (data.code == 200) {
                        alert(data.msg);
                        LoadAnswer();
                        $('#comment').val('');
                    } else {
                        alert(data.msg);
                    }
                }
            });
        });
        function LoadAnswer() {
            $.ajax({
                url: '@Url.Action("ShowAnswer", "Question")',
                type: 'get',
                data: {
                    id:@Model.IDQuestion },
                success: function (data) {
                    if (data.code == 200) {
                        $('#ans').empty();
                        $.each(data.ds, function (k, v) {
                            let tr = '<div class="qa_container" style="margin-left:-70%;">';
                            tr += '<div class="col1">';
                            tr += '<div class="userimg"><img src="/Content/Images/avatar/'+v.Anh+'" alt="" srcset=""></div>';
                            tr += '<div class="vote">';
                            if (@ctu != @Model.IDAccount ||@ctu==v.ID ) {
                                tr += '<button class="upvote v" disabled><i class="fa fa-sort-asc" aria-hidden="true"></i></button>';
                                tr += ' <div class="count">' + v.Diem + '</div><button class="downvote v" disabled><i class="fa fa-sort-desc" aria-hidden="true"></i></button>';
                            }
                            else  if (@ol==v.IDAS ) {
                                tr += '<button class="upvote v" disabled onclick="PointAs(' + v.IDAS + ')"><i class="fa fa-sort-asc" aria-hidden="true"></i></button>';
                                tr += ' <div class="count">' + v.Diem + '</div><button class="downvote v" onclick="PointAs(' + v.IDAS + ')"><i class="fa fa-sort-desc" aria-hidden="true"></i></button>';
                            }
                            else
                            {
                                tr += '<button class="upvote v" onclick="PointAs(' + v.IDAS + ')"><i class="fa fa-sort-asc" aria-hidden="true"></i></button>';
                                tr += ' <div class="count">' + v.Diem + '</div><button class="downvote v" onclick="PointAs('+v.IDAS +')"><i class="fa fa-sort-desc" aria-hidden="true"></i></button>';
                            }
                            tr += '</div>';
                            tr += '</div>';
                            tr += '<div class="col2">';
                            tr += '<div class="infobar cdw"><div class="name">' + v.Ten + '</div><div class="date">Asked :</div></div>';
                            if ( @ol==v.IDAS) {
                                    tr += '<p style="color:forestgreen;"><i class="fa fa-check" style="color:forestgreen;"></i>Câu trả lời hữu ích</p>';
                                }
                            tr += '<br>';
                            tr += '<div class="details">';
                            tr += v.ND + '</div>';
                            tr += '</div>';
                            $('#ans').append(tr);
                        });
                    }

                    else {
                        alert("")
                    }
                }
            });
        };
        $('#increaseq').click(function () {
            $.ajax({
                url: '@Url.Action("TPointQ", "Info")',
                type: 'post',
                data: {
                    idneed: @Model.IDAccount,
                    idquestion:@Model.IDQuestion},
                success: function (data) {
                    if (data.code == 200) {
                        LoadPoint();
                        T();
                    } else {
                        alert("Erro");
                    }
                }
            });
        });
        $('#reduceq').click(function () {
            $.ajax({
                url: '@Url.Action("GPointQ", "Info")',
                type: 'post',
                data: {
                    idneed: @Model.IDAccount,
                    idquestion:@Model.IDQuestion},
                success: function (data) {
                    if (data.code == 200) {
                        LoadPoint();
                        G();
                    } else {
                        alert("Erro");
                    }
                }
            });
        });
        function LoadPoint() {
            let node = document.getElementById('point');
                $.ajax({
                    url: '@Url.Action("ShowPoint", "Info")',
                    data: {
                    id: @Model.IDAccount},
                    success: function (resp) {
                        node.innerHTML = resp.resp;
                    },
                    error: function () { alert("Erro not show"); }
                }); // return data from the ajax request
            }
        function T() {
            $('#increaseq').prop('disabled', true);
            $('#reduceq').prop('disabled', false);
        }
        function G() {
            $('#reduceq').prop('disabled', true);
            $('#increaseq').prop('disabled', false);
        }
        function PointAs(idas) {
            $.ajax({
                url: '@Url.Action("PointAS", "Question")',
                type: 'post',
                data: {
                    idas: idas,
                    idquestion:@Model.IDQuestion},
                success: function (data) {
                    if (data.code == 200) {
                        LoadAnswer();
                    } else {
                        alert("Erro");
                    }
                }
            });
        }
    </script>

}